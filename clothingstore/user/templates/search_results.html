{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-white text-gray-900">

  <div class="px-4 py-5 sm:px-6 lg:px-16 border-b border-gray-300">
    <form method="get" action="{% url 'search_results' %}">
      <div class="flex justify-center relative">
        <div class="flex items-center w-full max-w-2xl px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm">
          <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            name="q"
            value="{{ query }}"
            id="search-input"
            autocomplete="off"
            class="ml-3 bg-transparent w-full text-sm focus:outline-none text-gray-800 placeholder-gray-400"
            placeholder="Search for products or categories..."
            required
          >
        </div>
        <div id="suggestion-box"
             class="absolute top-full mt-2 w-full max-w-2xl bg-white border border-gray-200 rounded shadow-md z-50 hidden"></div>
      </div>
    </form>
  </div>

  <div class="w-full px-4 py-3 bg-white border-b border-gray-300 flex items-center justify-between sm:justify-start sm:gap-4">
    <span class="text-sm font-medium text-gray-700">Filters</span>
    <button onclick="toggleFilter()" class="ml-auto sm:ml-0 flex items-center gap-2 border border-gray-300 px-3 py-1 rounded text-sm hover:bg-black hover:text-white transition-all">
      <img src="{% static 'icons/filter.svg' %}" alt="Filter" class="w-4 h-4">
      <span>Open Filters</span>
    </button>
  </div>

  {% if query %}
  <div class="px-4 py-3 text-sm text-gray-600">
    Showing results for <strong class="text-black">"{{ query }}"</strong> — {{ result_count }} product{{ result_count|pluralize }} found.
  </div>
  {% endif %}

  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 px-3 pt-4 pb-10">
    {% for product in products %}
    <div class="w-full">
      <div class="relative">
        <a href="{% url 'product_detail' product.slug %}">
          <img src="{{ product.primary_image.url }}" alt="{{ product.name }}" class="w-full h-auto object-contain bg-white">
        </a>
        <a href="{% url 'product_detail' product.slug %}">
          <button class="absolute top-2 right-2 bg-black text-white text-xs px-4 py-2 rounded shadow-md hover:shadow-lg transition-all">
            ADD
          </button>
        </a>
      </div>
      <div class="pt-1 pb-2"> {# Added pb-2 for better spacing below prices #}
        <p class="text-xs sm:text-sm text-gray-900 leading-tight truncate">{{ product.name }}</p>

        {# Price per Piece - Main and larger #}
        <div class="text-base font-bold text-gray-900 mt-1"> {# Increased size and bold #}
          ₹{{ product.get_current_price_per_piece|floatformat:0 }} <span class="text-xs font-normal text-gray-600">/ Piece</span>
        </div>

        {# Price per Set - Smaller and less prominent #}
        {% if product.get_total_pieces_in_set > 0 %}
            <p class="text-xs text-gray-500 mt-0.5"> {# Smaller text and lighter color #}
                Set: ₹{{ product.discount_price|default:product.price|floatformat:0 }}
            </p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <form method="get" id="filterPanel" class="fixed bottom-0 left-0 w-full bg-white z-50 h-[50vh] transform translate-y-full transition-transform duration-300 ease-in-out shadow-2xl rounded-t-xl">
  <div class="h-full flex flex-col">
    <div class="flex justify-between items-center px-4 py-2 border-b">
      <h2 class="text-base font-semibold">Filters</h2>
      <button type="button" onclick="toggleFilter()" class="text-sm text-gray-500">Close ✕</button>
    </div>

    <div class="flex-1 overflow-y-auto px-4 pb-20 pt-2">

      <div>
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('sortBy')">
          <h3 class="font-medium text-sm">Sort By</h3>
          <span id="icon-sortBy">+</span>
        </div>
        <div id="section-sortBy" class="mt-2 hidden text-sm text-gray-700">
          <label><input type="radio" name="sort" value="popular"> Popular</label><br>
          <label><input type="radio" name="sort" value="high"> Price: High to Low</label><br>
          <label><input type="radio" name="sort" value="low"> Price: Low to High</label><br>
          <label><input type="radio" name="sort" value="new"> New</label>
        </div>
      </div>

      <div class="mt-4">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('size')">
          <h3 class="font-medium text-sm">Size</h3>
          <span id="icon-size">+</span>
        </div>
        <div id="section-size" class="mt-2 hidden flex flex-wrap gap-2 text-sm text-gray-700">
          {% for size in sizes %}
            <label><input type="checkbox" name="size" value="{{ size }}"> {{ size }}</label>
          {% endfor %}
        </div>
      </div>

      <div class="mt-4">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('color')">
          <h3 class="font-medium text-sm">Color</h3>
          <span id="icon-color">+</span>
        </div>
        <div id="section-color" class="mt-2 hidden flex flex-wrap gap-2 text-sm text-gray-700">
          {% for color in colors %}
            <label><input type="checkbox" name="color" value="{{ color }}"> {{ color }}</label>
          {% endfor %}
        </div>
      </div>

      <div class="mt-4">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('sleeves')">
          <h3 class="font-medium text-sm">Sleeves</h3>
          <span id="icon-sleeves">+</span>
        </div>
        <div id="section-sleeves" class="mt-2 hidden flex flex-wrap gap-2 text-sm text-gray-700">
          {% for sleeve in sleeves %}
            <label><input type="checkbox" name="sleeves" value="{{ sleeve }}"> {{ sleeve }}</label>
          {% endfor %}
        </div>
      </div>

      <div class="mt-4">
        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('price')">
          <h3 class="font-medium text-sm">Price</h3>
          <span id="icon-price">+</span>
        </div>
        <div id="section-price" class="mt-2 hidden flex items-center gap-2 text-sm">
          <input type="number" name="min_price" placeholder="Min" class="border rounded px-2 py-1 w-20 text-center">
          <span>-</span>
          <input type="number" name="max_price" placeholder="Max" class="border rounded px-2 py-1 w-20 text-center">
        </div>
      </div>

    </div>

    <div class="absolute bottom-0 left-0 w-full bg-white px-4 py-3 border-t">
      <button type="submit" class="w-full py-2 bg-black text-white font-medium text-sm rounded">
        Apply Filters
      </button>
    </div>
  </div>
</form>

</div>

<script>
  function toggleFilter() {
    const panel = document.getElementById('filterPanel');
    panel.classList.toggle('translate-y-full');
  }

  function toggleSection(id) {
    const section = document.getElementById('section-' + id);
    const icon = document.getElementById('icon-' + id);
    const isHidden = section.classList.contains('hidden');

    if (isHidden) {
      section.classList.remove('hidden');
      icon.textContent = '−';
    } else {
      section.classList.add('hidden');
      icon.textContent = '+';
    }
  }

  // Live Suggestions (unchanged)
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById('search-input');
    const suggestionBox = document.getElementById('suggestion-box');
    let timeout = null;

    input.addEventListener("input", () => {
      const query = input.value.trim();
      if (timeout) clearTimeout(timeout);

      if (query.length > 1) {
        timeout = setTimeout(() => {
          fetch(`/search/suggestions/?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
              suggestionBox.innerHTML = "";
              if (data.products.length > 0) {
                data.products.forEach(product => {
                  const item = document.createElement("a");
                  item.href = `/product/${product.slug}/`;
                  item.className = "flex items-center gap-3 px-4 py-3 hover:bg-gray-50 border-b border-gray-100";

                  const img = document.createElement("img");
                  img.src = product.image;
                  img.alt = product.name;
                  img.className = "w-10 h-10 rounded object-cover";

                  const info = document.createElement("div");
                  info.className = "flex-1";
                  info.innerHTML = `
                    <p class="text-sm font-medium text-gray-800">${product.name}</p>
                    <p class="text-xs text-gray-500">${product.price_display}</p>
                  `;

                  item.appendChild(img);
                  item.appendChild(info);
                  suggestionBox.appendChild(item);
                });
                suggestionBox.classList.remove("hidden");
              } else {
                suggestionBox.classList.add("hidden");
              }
            });
        }, 250);
      } else {
        suggestionBox.classList.add("hidden");
      }
    });

    document.addEventListener("click", (e) => {
      if (!input.contains(e.target) && !suggestionBox.contains(e.target)) {
        suggestionBox.classList.add("hidden");
      }
    });
  });
</script>
{% endblock %}