{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-10 px-4 sm:px-8 lg:px-20 font-[Montserrat]">
  <h1 class="text-2xl font-semibold mb-8 text-gray-900">ðŸ§¾ Checkout</h1>
  
  <div id="message-container" class="mb-6"></div>

  <div class="grid lg:grid-cols-3 gap-10">

    <div class="bg-white p-6 rounded-xl shadow-sm text-sm order-1 lg:order-last lg:sticky lg:top-20 h-fit">
      <h3 class="text-lg font-semibold mb-4 text-gray-900">Order Summary</h3>
      <div class="space-y-4 max-h-[400px] overflow-y-auto pr-1">
        
        {% for item in cart_items %}
        <div class="flex gap-4 border-b pb-4">
          <img src="{{ item.product.primary_image.url }}" class="w-16 h-16 rounded object-cover border">
          <div class="flex-1">
            <p class="font-medium text-gray-900">{{ item.product.name }}</p>
            <p class="text-gray-500">Size: {{ item.product.sizes }} | Color: {{ item.color.name }}</p>
            <p class="text-gray-500">Qty: {{ item.quantity }} sets</p>
            <p class="font-semibold text-gray-800 mt-1">Total: â‚¹{{ item.total_price|floatformat:0 }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="mt-6 text-sm space-y-2">
        <div class="flex justify-between text-gray-700">
          <span>Subtotal</span>
          <span id="summary-subtotal">â‚¹{{ subtotal|floatformat:0 }}</span>
        </div>
        <div class="flex justify-between">
          <span>Shipping</span>
          <span id="summary-shipping" class="text-xs text-gray-500">Enter pincode to calculate</span>
        </div>
        <hr>
        <div class="flex justify-between font-bold text-base text-gray-900">
          <span>Grand Total</span>
          <span id="summary-grand-total">â‚¹{{ subtotal|floatformat:0 }}</span>
        </div>
        <div id="cod-note-container" class="hidden text-xs text-gray-600 bg-gray-100 p-2 rounded-md mt-2">
          You are paying the shipping fee now. The remaining amount of 
          <strong class="text-gray-800">â‚¹{{ subtotal|floatformat:0 }}</strong> is to be paid on delivery.
        </div>
      </div>
    </div>

    <form method="POST" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm space-y-6 order-last lg:order-1" id="checkout-form">
      {% csrf_token %}
      <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">

      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div>
          <label class="text-gray-600">Full Name *</label>
          <input name="full_name" type="text" value="{{ form_data.full_name|default:user.full_name|default:'' }}" required
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">
        </div>
        <div>
          <label class="text-gray-600">Phone *</label>
          <input name="phone" type="text" value="{{ form_data.phone|default:user.phone_number|default:'' }}" required
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">
        </div>
        <div>
          <label class="text-gray-600">Email</label>
          <input name="email" type="email" value="{{ form_data.email|default:user.email|default:'' }}"
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">
        </div>
        <div>
          <label class="text-gray-600">Pincode *</label>
          <input name="pincode" id="pincode-input" type="text" value="{{ form_data.pincode|default:'' }}" required
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">
        </div>
        <div class="md:col-span-2">
          <label class="text-gray-600">Address *</label>
          <textarea name="address" required
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">{{ form_data.address|default:'' }}</textarea>
        </div>
        <div>
          <label class="text-gray-600">City *</label>
          <input name="city" type="text" value="{{ form_data.city|default:'' }}" required
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">
        </div>
        <div>
          <label class="text-gray-600">State *</label>
          <input name="state" type="text" value="{{ form_data.state|default:'' }}" required
            class="w-full mt-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black">
        </div>
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-900">Payment Method</label>
        <div class="mt-2 grid sm:grid-cols-2 gap-4">
          <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-black has-[:checked]:text-white has-[:checked]:border-black">
            <input type="radio" name="payment_method" value="RZP" class="form-radio h-4 w-4" checked>
            <div class="ml-3 text-sm">
              <p class="font-semibold">Prepaid</p>
              <p class="text-xs">Pay full amount now</p>
            </div>
          </label>
          <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-black has-[:checked]:text-white has-[:checked]:border-black">
            <input type="radio" name="payment_method" value="COD" class="form-radio h-4 w-4">
            <div class="ml-3 text-sm">
              <p class="font-semibold">Cash on Delivery</p>
              <p class="text-xs">Pay only shipping fee now</p>
            </div>
          </label>
        </div>
      </div>

      <div>
        <button type="button" id="calculate-shipping-btn" class="w-full mt-4 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
          Calculate Shipping
        </button>
      </div>

      <div>
        <button type="submit" id="pay-now-btn" disabled
          class="mt-6 w-full py-3 bg-black text-white rounded font-semibold transition text-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
          Proceed to Pay
        </button>
      </div>
    </form>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- Element Definitions ---
  const pincodeInput = document.getElementById('pincode-input');
  const calculateBtn = document.getElementById('calculate-shipping-btn');
  const payBtn = document.getElementById('pay-now-btn');
  const messageContainer = document.getElementById('message-container');
  const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const subtotal = parseFloat("{{ subtotal }}");

  const summaryShippingEl = document.getElementById('summary-shipping');
  const summaryGrandTotalEl = document.getElementById('summary-grand-total');
  const codNoteContainer = document.getElementById('cod-note-container');

  // --- State Reset Function ---
  function resetShippingState() {
    payBtn.disabled = true;
    payBtn.innerText = 'Proceed to Pay';
    summaryShippingEl.classList.add('text-gray-500');
    summaryShippingEl.innerText = 'Enter pincode to calculate';
    summaryGrandTotalEl.innerText = `â‚¹${Math.round(subtotal)}`;
    codNoteContainer.classList.add('hidden');
    messageContainer.innerHTML = '';
  }

  // --- Event Listeners ---
  pincodeInput.addEventListener('input', resetShippingState);
  paymentMethodRadios.forEach(radio => radio.addEventListener('change', resetShippingState));
  calculateBtn.addEventListener('click', handleShippingCalculation);

  // --- Main Calculation Logic ---
  function handleShippingCalculation() {
    const pincode = pincodeInput.value;
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

    if (pincode.length !== 6 || !/^\d+$/.test(pincode)) {
        messageContainer.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">Please enter a valid 6-digit pincode.</div>`;
        return;
    }

    calculateBtn.innerText = 'Calculating...';
    calculateBtn.disabled = true;
    resetShippingState(); // Clear previous state before new calculation

    // âœ… FIXED: Sending data as JSON to match the backend view
    fetch("{% url 'ajax_calculate_shipping' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({
        pincode: pincode,
        payment_method: paymentMethod
      })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Server error'); });
        }
        return response.json();
    })
    .then(data => {
      const shippingCharge = parseFloat(data.shipping_charge);
      const grandTotal = parseFloat(data.grand_total);
      
      summaryShippingEl.innerText = `â‚¹${Math.round(shippingCharge)}`;
      summaryShippingEl.classList.remove('text-gray-500');
      summaryGrandTotalEl.innerText = `â‚¹${Math.round(grandTotal)}`;
      
      let amountToPay = grandTotal;

      if (paymentMethod === 'COD') {
        amountToPay = shippingCharge;
        codNoteContainer.classList.remove('hidden');
        payBtn.innerText = `Pay Shipping â‚¹${Math.round(amountToPay)}`;
      } else {
        payBtn.innerText = `Pay â‚¹${Math.round(amountToPay)}`;
      }

      payBtn.disabled = false;
      messageContainer.innerHTML = `<div class="p-4 rounded-md bg-green-100 text-green-700">Shipping calculated. You can now proceed to pay.</div>`;
    })
    .catch(error => {
      messageContainer.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">${error.message}</div>`;
      resetShippingState();
    })
    .finally(() => {
      calculateBtn.innerText = 'Calculate Shipping';
      calculateBtn.disabled = false;
    });
  }

  // --- Razorpay Handler ---
  {% if razorpay_order %}
  var options = {
      "key": "{{ razorpay_key }}",
      "amount": "{{ amount_to_pay_now }}",
      "currency": "INR",
      "name": "Your Store Name",
      "description": "Order Payment",
      "order_id": "{{ razorpay_order.id }}",
      "handler": function (response){
          document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
          document.getElementById('checkout-form').submit();
      },
      "prefill": {
          "name": "{{ order.full_name }}",
          "email": "{{ order.email }}",
          "contact": "{{ order.phone }}"
      },
      "theme": { "color": "#000000" }
  };
  var rzp1 = new Razorpay(options);
  
  // Handle payment failure
  rzp1.on('payment.failed', function (response){
      messageContainer.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">Payment failed: ${response.error.description}. Please try again.</div>`;
      // Re-enable the form fields if needed
  });
  
  rzp1.open();

  // Visually indicate payment is in progress
  document.getElementById('pay-now-btn').disabled = true;
  document.getElementById('pay-now-btn').innerText = 'Processing Payment...';
  {% endif %}
});
</script>
{% endblock %}